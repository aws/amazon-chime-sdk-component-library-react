<Meta title="Migration to V3" />

# Migration from 2.0 to 3.0

Version 3 of the Amazon Chime React Component Library makes small changes to the interface of the library to make it more customizable.

### IMPORTANT - Version 3 of the library also requires a dependency to version 3.0.0 or higher of the amazon-chime-sdk-js.

In many cases, you will need to adjust your application code because interface parameters to root providers like `MeetingProvider` are updated.

## Installation

Installation involves adjusting your package.json to depend on version 3.x.x

```
npm uninstall amazon-chime-sdk-component-library-react amazon-chime-sdk-js
npm install --save amazon-chime-sdk-component-library-react@beta amazon-chime-sdk-js@beta
```

## What's New

- Add a new interface `MeetingManagerJoinOptions` containing `deviceLabels`, `eventController`, `enableWebAudio`, and `activeSpeakerPolicy` properties. This interface is used for optional parameter `options` of `MeetingManager.join()` API.
- Add `deviceLabels`, `eventController`, `enableWebAudio`, and `activeSpeakerPolicy` to `MeetingManagerJoinOptions` interface.
- Add `LoggerProvider` and `useLogger` components to enable unniversal logging in component library.
- Update the `compilerOptions.target` in `tsconfig.json` from `es5` to `ES2015 (ES6)`.
- Update `MeetingManager.join()` API to have a require parameter `meetingSessionConfiguration: MeetingSessionConfiguration` and an optional parameter `options?: MeetingManagerJoinOptions`. With `meetingSessionConfiguration` parameter builders have direct access to `MeetingSessionConfiguration` which allows more flexibility to customize the `MeetingSession`. With `options` parameter, builders can easily config the `enableWebAudio`, `logger`, `activeSpeakerPolicy`, `deviceLabels` and `eventController` before joining the meeting.
- Remove `useSelectAudioInputDevice`, `useSelectAudioOutputDevice` and `useSelectVideoInputDevice` hook.
- Remove `MeetingSessionConfiguration` properties from `MeetingProvider` props.
- Remove `deviceLabels`, `eventController`, `logLevel`, `postLogConfig`, `logger`, `enableWebAudio`, and `activeSpeakerPolicy` from `MeetingProvider` props.
- Remove `meetingRegion` from `MeetingManager`. Previously we just cache this value from meetingInfo returned by [CreateMeeting](https://docs.aws.amazon.com/chime/latest/APIReference/API_CreateMeeting.html) but it is not used anywhere in the library.
- Remove legacy metrics `videoDownstreamGoogFrameHeight`, `videoDownstreamGoogFrameWidth`, `videoUpstreamGoogFrameHeight` and `videoUpstreamGoogFrameWidth` from the `videoStreamMetrics` returned by the `useMediaStreamMetrics` hook to adopt to Amazon Chime SDK for JavaScript V3 changes ([aws/amazon-chime-sdk-js#2086](https://github.com/aws/amazon-chime-sdk-js/pull/2086)).
- Remove preset device selection options ("None" and "440 Hz" for audio input device. "None", "Blue" and "SMTP Color Bars" for video input device). Remove `appendSampleDevices` from Props of `CameraSelection`, `MicSelection`, `AudioInputControl`, `AudioInputVFcontrol`, and `VideoInputControl`. Remove `DeviceConfig` type. Remove `additionalDevices` from Props of `useAudioInputs` and `useVideoInputs` hook.
- Rename the `global` property of `DefaultTheme` Interface to `globalStyle` to avoid conflict with reserved keyword `global`.
- Rename `DevicePermissionStatus.UNSET` to `DevicePermissionStatus.UNTRIGGERED` and `DevicePermissionStatus` to `DeviceLabelTriggerStatus`.
- Rename `useDevicePermissionStatus` to `useDeviceLabelTriggerStatus`.
- Rename `devicePermissionsObservers` to `deviceLabelTriggerStatusObservers` and corresponding `subscribe`, `unsubscribe`, and `publish` functions.
- Rename `deviceLabelTriggerChangeObservers` to `deviceLabelTriggerObservers` and corresponding `subscribe`, `unsubscribe`, and `publish` functions.
- Rename `selectAudioInputDevice` to `startAudioInputDevice`, `selectVideoInputDevice` to `startVideoInputDevice`, and `selectAudioOutputDevice` to `startAudioOutputDevice`.
- Revert "Add Observer to select input device error" ([PR #493](https://github.com/aws/amazon-chime-sdk-component-library-react/pull/493)). `useAudioInputs` and `useVideoInputs` hook no longer return `selectDeviceError`. `startAudioInputDevice`, `startVideoInputDevice`, and `startAudioOutputDevice` method of `MeetingManager` now throw error when failed.
- Deprecate `useBandwidthMetrics` hook in favor of `useMediaStreamMetrics`.

### `MeetingProvider` props change

`MeetingProvider` no longer takes the following props:

- `MeetingSessionConfiguration` properties:
- `VideoDownlinkBandwidthPolicy`
- `VideoUplinkBandwidthPolicy`
- `simulcastEnabled`
- `reconnectTimeoutMs`
- `keepLastFrameWhenPaused`
- Other props:
- `deviceLabels`
- `eventController`
- `enableWebAudio`
- `activeSpeakerPolicy`

These props can rather be updated by passing the `MeetingSessionConfiguration` object or by passing `options` props to `meetingManager.join()` method.

You can learn more about the `meetingManager.join()` method here: [MeetingManager](/docs/sdk-providers-meetingmanager--page).

#### Examples

##### VideoDownlinkBandwidthPolicy

The following example uses `VideoDownlinkBandwidthPolicy` property as an example to showcase the change.

Before in 2.x:

```jsx
import { useMeetingManager } from 'amazon-chime-sdk-component-library-react';

const App = () => {
  // MyVideoDownlinkBandwidthPolicy is a custom class implementing VideoDownlinkBandwidthPolicy interface from amazon-chime-sdk-js.
  const videoDownlinkBandwidthPolicy = new MyVideoDownlinkBandwidthPolicy();
  const meetingConfig = {
    videoDownlinkBandwidthPolicy,
  };

  return (
    <MeetingProvider {...meetingConfig}>
      <MyApp />
    </MeetingProvider>
  );
};

const MyApp = () => {
  const meetingManager = useMeetingManager();
  await meetingManger.join({
    data.Meeting,
    data.Attendee
  });

  return (
    <div>
      ...
    </div>
  );
};
```

After in 3.x:

```jsx
import { useMeetingManager } from 'amazon-chime-sdk-component-library-react';
import { MeetingSessionConfiguration } from 'amazon-chime-sdk-js';

const App = () => {
  return (
    <MeetingProvider>
      <MyApp />
    </MeetingProvider>
  );
};

const MyApp = () => {
  // MyVideoDownlinkBandwidthPolicy is a custom class implementing VideoDownlinkBandwidthPolicy interface from amazon-chime-sdk-js.
  const videoDownlinkBandwidthPolicy = new MyVideoDownlinkBandwidthPolicy();

  const meetingSessionConfiguration = new MeetingSessionConfiguration(
    data.Meeting,
    data.Attendee
  );
  meetingSessionConfiguration.videoDownlinkBandwidthPolicy =
    videoDownlinkBandwidthPolicy;

  const meetingManager = useMeetingManager();
  await meetingManager.join(meetingSessionConfiguration);

  return <div>...</div>;
};
```

##### simulcastEnabled

One thing to note is that the `MeetingProvider` props might not have the same mapping with `MeetingSessionConfiguration` properties.
For example, `simulcastEnabled` in `MeetingProvider` and the property in `MeetingSessionConfiguration` is different. The following code example should help remove any confusion.

Before in 2.x:

```jsx
import { useMeetingManager } from 'amazon-chime-sdk-component-library-react';

const App = () => {
  const meetingConfig = {
    simulcastEnabled: false,
  };

  return(
    <MeetingProvider {...meetingConfig}>
      <MyApp />
    </MeetingProvider>
  );
};

const MyApp = () => {
  const meetingManager = useMeetingManager();
  await meetingManger.join({
    data.Meeting,
    data.Attendee
  });

  return (
    <div>
      ...
    </div>
  );
};
```

After in 3.x:

```jsx
import { useMeetingManager } from 'amazon-chime-sdk-component-library-react';
import { MeetingSessionConfiguration } from 'amazon-chime-sdk-js';

const App = () => {
  return (
    <MeetingProvider>
      <MyApp />
    </MeetingProvider>
  );
};

const MyApp = () => {
  const meetingSessionConfiguration = new MeetingSessionConfiguration(
    data.Meeting,
    data.Attendee
  );
  meetingSessionConfiguration.enableSimulcastForUnifiedPlanChromiumBasedBrowsers = false;

  const meetingManager = useMeetingManager();
  await meetingManager.join(meetingSessionConfiguration);

  return <div>...</div>;
};
```

##### enableWebAudio

The following example uses `enableWebAudio` property as an example to showcase the change. `enableWebAudio` is chosen here because it is one of the properties that is affected and it is not part of `MeetingSessionConfiguration`.

Before in 2.x:

```jsx
import { useMeetingManager } from 'amazon-chime-sdk-component-library-react';

const App = () => {
  const meetingConfig = {
    enableWebAudio: true,
  };

  return(
    <MeetingProvider {...meetingConfig}>
      <MyApp />
    </MeetingProvider>
  );
};

const MyApp = () => {
  const meetingManager = useMeetingManager();
  await meetingManger.join({
    data.Meeting,
    data.Attendee
  });

  return (
    <div>
      ...
    </div>
  );
};
```

After in 3.x:

```jsx
import { useMeetingManager } from 'amazon-chime-sdk-component-library-react';
import { MeetingSessionConfiguration } from 'amazon-chime-sdk-js';

const App = () => {
  return (
    <MeetingProvider>
      <MyApp />
    </MeetingProvider>
  );
};

const MyApp = () => {
  const meetingSessionConfiguration = new MeetingSessionConfiguration(
    data.Meeting,
    data.Attendee
  );
  const options = {
    enableWebAudio: true,
  };

  const meetingManager = useMeetingManager();
  await meetingManager.join(meetingSessionConfiguration, options);

  return <div>...</div>;
};
```

### `MeetingManager` `join` method parameter change

In V3, `MeetingManager`'s `join` method takes `MeetingSessionConfiguraiton` and `options` as parameter.
`meetingInfo` and `attendeeInfo` parameters are removed from the interface and are rather passed to the constructor of `MeetingSessionConfiguration`.

Before in 2.x:

```jsx
import { useMeetingManager } from 'amazon-chime-sdk-component-library-react';

const MyApp = () => {
  const meetingManager = useMeetingManager();
  await meetingManager.join({
    data.Meeting,
    data.Attendee
  });
};
```

After in 3.x:

```jsx
import { useMeetingManager } from 'amazon-chime-sdk-component-library-react';
import { MeetingSessionConfiguration } from 'amazon-chime-sdk-js';

const MyApp = () => {
  const meetingSessionConfiguration = new MeetingSessionConfiguration(
    data.Meeting,
    data.Attendee
  );

  const meetingManager = useMeetingManager();
  await meetingManager.join(meetingSessionConfiguration);
};
```

### Updating `EventReporter` to `EventController`

Before in 2.x:

```jsx
const MyApp = () => {
  const meetingManager = useMeetingManager();
  const joinMeeting = async () => {
    const response = await fetch('/my-meetings-endpoint');
    const data = await response.json();
    const joinData = {
      meetingInfo: data.Meeting,
      attendeeInfo: data.Attendee,
      eventReporter: new NoOpEventReporter(),
    };
    try {
      await meetingManager.join(joinData);
    } catch {
      console.error('Something went wrong');
    }
  };

  return (
    <button onClick={joinMeeting}>Join Meeting</button>;
  );
};
```

After in 3.x:

```jsx
const MyApp = () => {
  const meetingManager = useMeetingManager();
  const joinMeeting = async () => {
    const response = await fetch('/my-meetings-endpoint');
    const data = await response.json();
    const meetingSessionConfiguration = new MeetingSessionConfiguration(data.Meeting, data.Attendee);
    const eventController = new DefaultEventController(
      meetingSessionConfiguration,
      new ConsoleLogger('SDK', LogLevel.WARN),
      new NoOpEventReporter()
    );
    const options = {
      eventController
    };

    try {
      await meetingManager.join(
        meetingSessionConfiguration,
        options
      );
    } catch {
      console.error('Something went wrong');
    }
  };

  return (
    <button onClick={joinMeeting}>Join Meeting</button>;
  );
};
```

## WebRTC Metrics Change

### Deprecation of `useBandwidthMetrics` hook

The `useBandwidthMetrics` hook exposes two WebRTC metrics:

- `availableOutgoingBandwidth`
- `availableIncomingBandwidth`.

The `useMediaStreamMetrics` covers all metrics of `useBandwidthMetrics` hook, so we decide to deprecate it in V3.

Before in 2.x:

To get the `availableOutgoingBandwidth` and `availableIncomingBandwidth` in V2.

```jsx
import React from 'react';
import {
  MeetingProvider,
  useBandwidthMetrics,
} from 'amazon-chime-sdk-component-library-react';

const App = () => (
  <MeetingProvider>
    <MyChild />
  </MeetingProvider>
);

const MyChild = () => {
  const metrics = useBandwidthMetrics();

  return (
    <>
      <p>Incoming Bandwidth: {metrics.availableIncomingBandwidth}</p>
      <p>Outgoing Bandwidth: {metrics.availableOutgoingBandwidth}</p>
    </>
  );
};
```

After in 3.x:

To get the `availableOutgoingBandwidth` and `availableIncomingBandwidth` in V3.

```jsx
import React from 'react';
import {
  MeetingProvider,
  useMediaStreamMetrics,
} from 'amazon-chime-sdk-component-library-react';

const App = () => (
  <MeetingProvider>
    <MyChild />
  </MeetingProvider>
);

const MyChild = () => {
  const metrics = useMediaStreamMetrics();

  return (
    <>
      <p>Incoming Bandwidth: {metrics.availableIncomingBandwidth}</p>
      <p>Bandwidth Outgoing: {metrics.availableOutgoingBandwidth}</p>
    </>
  );
};
```

## Enable logging using `useLogger` and `LoggerProvider`

Please check documentation on [`LoggerProvider`](https://aws.github.io/amazon-chime-sdk-component-library-react/?path=/story/sdk-providers-loggerprovider--page) for more information on its usage.

## StyledComponent

### DefaultTheme Interface

In V3 we rename the `global` property of `DefaultTheme` Interface to `globalStyle` to avoid conflict with reserved keyword `global`.
When you implement your own theme, you need to use `globalStyle` instead of `global`.

## Device

### Renaming

Below table summarizes all renaming of device management related stuff. Simply use new naming to replace old naming for migration.

| Before in 2.x                                               | After in 3.x                                               |
| ----------------------------------------------------------- | ---------------------------------------------------------- |
| `DevicePermissionStatus`                                    | `DeviceLabelTriggerStatus`                                 |
| `DevicePermissionStatus.UNSET`                              | `DevicePermissionStatus.UNTRIGGERED`                       |
| `useDevicePermissionStatus`                                 | `useDeviceLabelTriggerStatus`                              |
|                                                             |                                                            |
| `MeetingManager.devicePermissionStatus`                     | `MeetingManager.deviceLabelTriggerStatus`                  |
|                                                             |                                                            |
| `MeetingManager.selectAudioInputDevice()`                   | `MeetingManager.startAudioInputDevice()`                   |
| `MeetingManager.selectAudioOutputDevice()`                  | `MeetingManager.startAudioOutputDevice()`                  |
| `MeetingManager.selectVideoInputDevice()`                   | `MeetingManager.startVideoInputDevice()`                   |
|                                                             |                                                            |
| `MeetingManager.devicePermissionsObservers`                 | `MeetingManager.deviceLabelTriggerStatusObservers`         |
| `MeetingManager.subscribeToDevicePermissionStatus()`        | `MeetingManager.subscribeToDeviceLabelTriggerStatus()`     |
| `MeetingManager.unsubscribeFromDevicePermissionStatus()`    | `MeetingManager.unsubscribeFromDeviceLabelTriggerStatus()` |
|                                                             |                                                            |
| `MeetingManager.deviceLabelTriggerChangeObservers`          | `MeetingManager.deviceLabelTriggerObservers`               |
| `MeetingManageer.subscribeToDeviceLabelTriggerChange()`     | `MeetingManageer.subscribeToDeviceLabelTrigger()`          |
| `MeetingManageer.unsubscribeFromDeviceLabelTriggerChange()` | `MeetingManageer.unsubscribeFromDeviceLabelTrigger()`      |

### Update Type of Selected Device in MeetingManager

In V3, we improve type for selected device in `MeetingManager` and update the corresponding components and hooks.

#### MeetingManager Properties Change

| Before in 2.x                              | After in 3.x                                             |
| ------------------------------------------ | -------------------------------------------------------- |
| `selectedAudioOutputDevice: string | null` | `selectedAudioOutputDevice: string | null`               |
| `selectedAudioInputDevice: string | null`  | `selectedAudioInputDevice: AudioInputDevice | undefined` |
| `selectedVideoInputDevice: string | null`  | `selectedVideoInputDevice: VideoInputDevice | undefined` |

```js
type Device = string | MediaTrackConstraints | MediaStream;
type AudioInputDevice = Device | AudioTransformDevice | null;
type VideoInputDevice = Device | VideoTransformDevice;
```
#### Hooks Return Values Change

Before in 2.x

```js
// Selected audio output deivce. The type is `string | null`
const { selectedDevice } = useAudioOutputs();
// Selected audio input deivce. The type is `string | null`
const { selectedDevice } = useAudioInputs();
// Selected video input deivce. The type is `string | null`
const { selectedDevice } = useVideoInputs();
```

After in 3.x

```js
// Selected audio output deivce. The type is `string | null`
const { selectedDevice } = useAudioOutputs();
// Selected audio input deivce. The type is `AudioInputDevice | undefined`
const { selectedDevice } = useAudioInputs();
// Selected video input deivce. The type is `VideoInputDevice | undefined`
const { selectedDevice } = useVideoInputs();
```

### Remove `useSelectAudioInputDevice`, `useSelectAudioOutputDevice` and `useSelectVideoInputDevice` hook

In V3, we remove `useSelectAudioInputDevice`, `useSelectAudioOutputDevice` and `useSelectVideoInputDevice` hook. These hooks just expose device selection APIs from `MeetingManager`, thus they are redundant.

Before in 2.x:

```jsx
import React from 'react';
import {
  MeetingProvider,
  useSelectVideoInputDevice,
} from 'amazon-chime-sdk-component-library-react';

const App = () => (
  <MeetingProvider>
    <MyChild />
  </MeetingProvider>
);

const MyChild = () => {
  const selectVideoInput = useSelectVideoInputDevice();

  const handleClick = async () => {
    await selectVideoInput('device-id');
  };

  return (
    <button onClick={handleClick}>
      Start Video Input Device with ID 'device-id'
    </button>
  );
};
```

After in 3.x:

```jsx
import React from 'react';
import {
  MeetingProvider,
  useMeetingManager,
} from 'amazon-chime-sdk-component-library-react';

const App = () => (
  <MeetingProvider>
    <MyChild />
  </MeetingProvider>
);

const MyChild = () => {
  const meetingManager = useMeetingManager();

  const handleClick = async () => {
    try {
      await meetingManager.startVideoInputDevice('device-id');
    } catch (error) {
      // Handle device selection failure here
      console.error('Failed to start video input device');
    }
  };

  return (
    <button onClick={handleClick}>
      Start Video Input Device with ID 'device-id'
    </button>
  );
};
```

### Remove Preset Device Selection Options

In V3, we remove preset device selection options:

- "None", "440 Hz" for audio input device.
- "None", "Blue" and "SMTP Color Bars" for video input device.

The detailed changes are:

- Remove `appendSampleDevices` from Props of `CameraSelection`, `MicSelection`, `AudioInputControl`, `AudioInputVFcontrol`, and `VideoInputControl`.
- Remove `additionalDevices` from Props of `useAudioInputs` and `useVideoInputs` hook.
- Remove `DeviceConfig` type.

#### Components

Before in 2.x:

```jsx
import React from 'react';
import {
  MeetingProvider,
  CameraSelection,
} from 'amazon-chime-sdk-component-library-react';

const App = () => {
  return (
    <MeetingProvider>
      {/* If you don't want preset device selection options. */}
      <CameraSelection appendSampleDevices={false} />
    </MeetingProvider>
  );
};
```

After in 3.x:

```jsx
import React from 'react';
import {
  MeetingProvider,
  CameraSelection,
} from 'amazon-chime-sdk-component-library-react';

const App = () => {
  return (
    <MeetingProvider>
      {/* In V3, `CameraSelection` component no longer supports preset device selection options. */}
      <CameraSelection />
    </MeetingProvider>
  );
};
```

#### Hooks

Before in 2.x:

```tsx
import React from 'react';
import {
  MeetingProvider,
  useVideoInputs,
} from 'amazon-chime-sdk-component-library-react';

const App = () => (
  <MeetingProvider>
    <MyChild />
  </MeetingProvider>
);

const MyChild = () => {
  const videoInputConfig: DeviceConfig = {
    additionalDevices: false,
  };

  // `devices` does not contain preset device selection options.
  const { devices } = useVideoInputs(videoInputConfig);
  const items = devices.map((device) => (
    <li key={device.deviceId}>{device.label}</li>
  ));

  return (
    <div>
      <p>Devices</p>
      <ul>{items}</ul>
    </div>
  );
};
```

After in 3.x:

```jsx
import React from 'react';
import {
  MeetingProvider,
  useVideoInputs,
} from 'amazon-chime-sdk-component-library-react';

const App = () => (
  <MeetingProvider>
    <MyChild />
  </MeetingProvider>
);

const MyChild = () => {
  // In V3, `useVideoInputs` hook no longer supports preset device selection options.
  const { devices } = useVideoInputs();
  const items = devices.map((device) => (
    <li key={device.deviceId}>{device.label}</li>
  ));

  return (
    <div>
      <p>Devices</p>
      <ul>{items}</ul>
    </div>
  );
};
```

### Device Selection APIs Throw Error When Failed

In V2, we added `selectDeviceError` to `useAudioInputs` and `useVideoInputs` hook to get the error of `selectAudioInputDevice` and `selectVideoInputDevice` API from client side when they failed. In V3, we remove `selectDeviceError` from these hooks and throw error directly when `selectAudioInputDevice`, `selectVideoInputDevice`, and `selectAudioOutputDevice` methods of `MeetingManager` failed.

Before in 2.x:

```jsx
import React from 'react';
import {
  MeetingProvider,
  useMeetingManager,
  useVideoInputs,
} from 'amazon-chime-sdk-component-library-react';

const App = () => (
  <MeetingProvider>
    <MyChild />
  </MeetingProvider>
);

const MyChild = () => {
  const meetingManager = useMeetingManager();
  const { selectDeviceError } = useVideoInputs();

  const handleClick = async (): => {
    await meetingManager.selectVideoInputDevice('deviceId');
  };

  return (
    <button onClick={handleClick}>Select Video Input Device</button>
    {selectDeviceError && <p>{selectDeviceError?.message}</p>}
  );
};
```

After in 3.x:

```jsx
import React from 'react';
import {
  MeetingProvider,
  useMeetingManager,
} from 'amazon-chime-sdk-component-library-react';

const App = () => (
  <MeetingProvider>
    <MyChild />
  </MeetingProvider>
);

const MyChild = () => {
  const meetingManager = useMeetingManager();

  const handleClick = async (): => {
    try {
      await meetingManager.startAudioInputDevice('deviceId');
    } catch (error) {
      // Handle device selection error.
      console.error('Failed to select video input device', error);
    }
  };

  return (
    <button onClick={handleClick}>Select Video Input Device</button>
  );
};
```
